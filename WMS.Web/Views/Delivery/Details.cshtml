@model WMS.Web.Models.DeliveryViewModel
@{
    ViewData["Title"] = "Delivery Details";
    var statusClass = Model.Status switch
    {
        "Pending" => "bg-secondary",
        "In Transit" => "bg-info",
        "Out for Delivery" => "bg-warning text-dark",
        "Delivered" => "bg-success",
        "Failed" => "bg-danger",
        "Returned" => "bg-dark",
        _ => "bg-secondary"
    };
}

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1">Delivery Tracking</h2>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item"><a asp-controller="Home" asp-action="Index">Home</a></li>
                    <li class="breadcrumb-item"><a asp-controller="Delivery" asp-action="Index">Deliveries</a></li>
                    <li class="breadcrumb-item active">@Model.TrackingNumber</li>
                </ol>
            </nav>
        </div>
        <div>
            <a asp-action="Index" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Back to List
            </a>
            @if (Model.Status != "Delivered" && Model.Status != "Failed" && Model.Status != "Returned")
            {
                <a asp-action="UpdateStatus" asp-route-id="@Model.Id" class="btn btn-primary">
                    <i class="bi bi-pencil"></i> Update Status
                </a>
            }
        </div>
    </div>

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <div class="row">
        <div class="col-lg-8">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">Tracking Information</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="text-muted small">Tracking Number</label>
                            <div class="fw-bold fs-5">
                                <code>@Model.TrackingNumber</code>
                                <button type="button" class="btn btn-sm btn-outline-secondary ms-2" onclick="copyToClipboard('@Model.TrackingNumber')">
                                    <i class="bi bi-clipboard"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="text-muted small">Status</label>
                            <div>
                                <span class="badge @statusClass fs-6">@Model.Status</span>
                            </div>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="text-muted small">Carrier</label>
                            <div class="fw-bold">
                                <i class="bi bi-truck text-primary"></i> @Model.Carrier
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="text-muted small">Outbound Order ID</label>
                            <div><code>@Model.OutboundId</code></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">Delivery Timeline</h5>
                </div>
                <div class="card-body">
                    <div class="timeline">
                        @if (Model.ActualDeliveryDate.HasValue)
                        {
                            <div class="timeline-item timeline-success">
                                <div class="timeline-marker">
                                    <i class="bi bi-check-circle-fill"></i>
                                </div>
                                <div class="timeline-content">
                                    <h6 class="mb-1">Delivered</h6>
                                    <p class="text-muted mb-0">
                                        @Model.ActualDeliveryDate.Value.ToString("MMMM dd, yyyy HH:mm")
                                    </p>
                                </div>
                            </div>
                        }

                        @if (Model.Status == "Out for Delivery" || Model.ActualDeliveryDate.HasValue)
                        {
                            <div class="timeline-item timeline-@(Model.ActualDeliveryDate.HasValue ? "success" : "warning")">
                                <div class="timeline-marker">
                                    <i class="bi @(Model.ActualDeliveryDate.HasValue ? "bi-check-circle-fill" : "bi-truck")"></i>
                                </div>
                                <div class="timeline-content">
                                    <h6 class="mb-1">Out for Delivery</h6>
                                    <p class="text-muted mb-0">Package is with delivery driver</p>
                                </div>
                            </div>
                        }

                        @if (Model.Status == "In Transit" || Model.Status == "Out for Delivery" || Model.ActualDeliveryDate.HasValue)
                        {
                            <div class="timeline-item timeline-@(Model.Status == "Out for Delivery" || Model.ActualDeliveryDate.HasValue ? "success" : "info")">
                                <div class="timeline-marker">
                                    <i class="bi @(Model.Status == "Out for Delivery" || Model.ActualDeliveryDate.HasValue ? "bi-check-circle-fill" : "bi-arrow-repeat")"></i>
                                </div>
                                <div class="timeline-content">
                                    <h6 class="mb-1">In Transit</h6>
                                    <p class="text-muted mb-0">Package is on the way</p>
                                </div>
                            </div>
                        }

                        <div class="timeline-item timeline-@(Model.Status != "Pending" ? "success" : "secondary")">
                            <div class="timeline-marker">
                                <i class="bi @(Model.Status != "Pending" ? "bi-check-circle-fill" : "bi-circle")"></i>
                            </div>
                            <div class="timeline-content">
                                <h6 class="mb-1">Shipment Created</h6>
                                <p class="text-muted mb-0">
                                    @Model.CreatedAt.ToString("MMMM dd, yyyy HH:mm")
                                </p>
                            </div>
                        </div>
                    </div>

                    @if (Model.Status == "Failed")
                    {
                        <div class="alert alert-danger mt-3">
                            <i class="bi bi-exclamation-triangle"></i>
                            <strong>Delivery Failed</strong>
                            <p class="mb-0">The delivery attempt was unsuccessful. Please contact the carrier for more information.</p>
                        </div>
                    }
                    else if (Model.Status == "Returned")
                    {
                        <div class="alert alert-warning mt-3">
                            <i class="bi bi-arrow-return-left"></i>
                            <strong>Package Returned</strong>
                            <p class="mb-0">The package has been returned to sender.</p>
                        </div>
                    }
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Recipient Information</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="text-muted small">Recipient Name</label>
                            <div class="fw-bold">@Model.RecipientName</div>
                        </div>
                        <div class="col-md-6">
                            <label class="text-muted small">Contact Number</label>
                            <div>
                                <i class="bi bi-telephone"></i> @Model.RecipientPhone
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            <label class="text-muted small">Delivery Address</label>
                            <div class="border rounded p-3 bg-light">
                                <i class="bi bi-geo-alt text-primary"></i> @Model.ShippingAddress
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">Delivery Summary</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-2">
                        <span>Carrier:</span>
                        <span class="fw-bold">@Model.Carrier</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Status:</span>
                        <span class="badge @statusClass">@Model.Status</span>
                    </div>
                    <hr>
                    @if (Model.EstimatedDeliveryDate.HasValue)
                    {
                        <div class="mb-3">
                            <label class="text-muted small">Estimated Delivery</label>
                            <div class="fw-bold">
                                @Model.EstimatedDeliveryDate.Value.ToString("MMMM dd, yyyy")
                            </div>
                            @{
                                var daysUntilDelivery = (Model.EstimatedDeliveryDate.Value - DateTime.Now).Days;
                            }
                            @if (daysUntilDelivery > 0)
                            {
                                <small class="text-muted">In @daysUntilDelivery day(s)</small>
                            }
                            else if (daysUntilDelivery == 0)
                            {
                                <small class="text-success fw-bold">Today</small>
                            }
                            else
                            {
                                <small class="text-danger">Overdue by @Math.Abs(daysUntilDelivery) day(s)</small>
                            }
                        </div>
                    }
                    @if (Model.ActualDeliveryDate.HasValue)
                    {
                        <div class="mb-3">
                            <label class="text-muted small">Actual Delivery</label>
                            <div class="fw-bold text-success">
                                @Model.ActualDeliveryDate.Value.ToString("MMMM dd, yyyy HH:mm")
                            </div>
                        </div>
                    }
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Audit Information</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="text-muted small">Created By</label>
                        <div>@Model.CreatedBy</div>
                        <small class="text-muted">@Model.CreatedAt.ToString("MMM dd, yyyy HH:mm")</small>
                    </div>
                    @if (Model.UpdatedAt.HasValue)
                    {
                        <div>
                            <label class="text-muted small">Last Updated By</label>
                            <div>@Model.UpdatedBy</div>
                            <small class="text-muted">@Model.UpdatedAt.Value.ToString("MMM dd, yyyy HH:mm")</small>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <style>
        .timeline {
            position: relative;
            padding-left: 50px;
        }
        .timeline::before {
            content: '';
            position: absolute;
            left: 20px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #dee2e6;
        }
        .timeline-item {
            position: relative;
            margin-bottom: 30px;
        }
        .timeline-marker {
            position: absolute;
            left: -38px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            z-index: 1;
        }
        .timeline-success .timeline-marker {
            background: #d1e7dd;
            color: #0f5132;
        }
        .timeline-info .timeline-marker {
            background: #cff4fc;
            color: #055160;
        }
        .timeline-warning .timeline-marker {
            background: #fff3cd;
            color: #664d03;
        }
        .timeline-secondary .timeline-marker {
            background: #e2e3e5;
            color: #41464b;
        }
        .timeline-content h6 {
            font-weight: 600;
            color: #212529;
        }
    </style>
}

@section Scripts {
    <script>
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(function() {
                alert('Tracking number copied to clipboard!');
            }, function(err) {
                console.error('Could not copy text: ', err);
            });
        }
    </script>
}
